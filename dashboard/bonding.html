<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonding Curve Tokens - Pump.fun Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="bonding-styles.css">
</head>
<body>
    <div class="status-bar">
        <div class="status-item">
            <span class="status-label">SOL Price:</span>
            <span class="status-value sol-price" id="sol-price">$---.--</span>
            <span class="price-source" id="price-source"></span>
        </div>
        <div class="status-item">
            <span class="status-label">System:</span>
            <div class="connection-indicator">
                <div class="connection-dot" id="connection-dot"></div>
                <span class="status-value" id="connection-status">Checking...</span>
            </div>
        </div>
        <div class="status-item">
            <span class="status-label">Active Bonding:</span>
            <span class="status-value" id="activeTokens">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">Near Graduation:</span>
            <span class="status-value" id="nearGraduation">0</span>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>âš¡ Bonding Curve Tokens</h1>
            <div class="header-controls">
                <div class="nav-section">
                    <a href="/" class="nav-link">All Tokens</a>
                    <a href="/bonding.html" class="nav-link active">âš¡ Bonding</a>
                    <a href="/graduated.html" class="nav-link">ðŸŽ“ Graduated</a>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="hot">ðŸ”¥ Hot (>80%)</button>
                    <button class="filter-btn" data-filter="new">New (<1h)</button>
                    <button class="filter-btn" data-filter="large">Large (>$100k)</button>
                </div>
                <div class="refresh-indicator">
                    <span id="last-update">Loading...</span>
                    <div class="refresh-spinner" id="spinner"></div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Active Tokens</div>
                <div class="stat-value" id="activeTokens">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Liquidity</div>
                <div class="stat-value" id="totalLiquidity">0 SOL</div>
            </div>
            <div class="stat-card stats-warning">
                <div class="stat-label">Near Graduation (>80%)</div>
                <div class="stat-value" id="nearGraduation">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Progress</div>
                <div class="stat-value" id="avgProgress">0%</div>
            </div>
        </div>

        <div class="table-container">
            <table class="token-table">
                <thead>
                    <tr>
                        <th class="text-left">TOKEN</th>
                        <th>PRICE</th>
                        <th>PROGRESS</th>
                        <th>LIQUIDITY</th>
                        <th>AGE</th>
                        <th>HOLDERS</th>
                        <th>5M</th>
                        <th>1H</th>
                        <th>6H</th>
                        <th>24H</th>
                        <th>MCAP</th>
                    </tr>
                </thead>
                <tbody id="token-list">
                    <tr>
                        <td colspan="11" class="loading">Loading bonding curve tokens...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="refresh-info">
            Auto-refreshes every 10 seconds â€¢ Last update: <span id="lastUpdateTime">-</span>
        </div>
    </div>

    <script>
        let allTokens = [];
        let currentFilter = 'all';

        function formatPrice(price) {
            if (!price || price === 0) return '$0.00';
            if (price < 0.00001) return `$${price.toFixed(8)}`;
            if (price < 0.01) return `$${price.toFixed(6)}`;
            if (price < 1) return `$${price.toFixed(4)}`;
            return `$${price.toFixed(2)}`;
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1e9) return `${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `${(num / 1e3).toFixed(2)}K`;
            return num.toFixed(2);
        }

        function formatAge(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return `${Math.floor(seconds)}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
            return `${Math.floor(seconds / 86400)}d`;
        }

        function formatChange(value) {
            if (value === null || value === undefined) return '<span class="text-secondary">-</span>';
            const formatted = value > 0 ? `+${value.toFixed(1)}%` : `${value.toFixed(1)}%`;
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'text-secondary';
            return `<span class="${className}">${formatted}</span>`;
        }

        function getProgressBarClass(progress) {
            if (progress >= 90) return 'progress-success';
            if (progress >= 80) return 'progress-warning';
            return '';
        }

        function renderToken(token) {
            const progressClass = getProgressBarClass(token.progress);
            
            return `
                <tr onclick="window.open('https://pump.fun/${token.address}', '_blank')" style="cursor: pointer;" title="${token.address}">
                    <td>
                        <div class="token-info">
                            ${token.image_uri ? 
                                `<img src="${token.image_uri}" alt="${token.symbol}" class="token-image">` : 
                                `<div class="token-placeholder">${token.symbol[0]}</div>`
                            }
                            <div>
                                <div class="token-name">${token.name}</div>
                                <div class="token-symbol">${token.symbol}</div>
                            </div>
                        </div>
                    </td>
                    <td class="monospace">${formatPrice(token.price_usd)}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar ${progressClass}" style="width: ${token.progress}%"></div>
                            <div class="progress-text">${token.progress.toFixed(1)}%</div>
                        </div>
                    </td>
                    <td>
                        <div class="bonding-info">
                            <div>${token.liquidity_sol.toFixed(2)} SOL</div>
                            <div class="liquidity-text">$${formatNumber(token.liquidity_usd)}</div>
                        </div>
                    </td>
                    <td>${formatAge(token.age)}</td>
                    <td>${token.holder_count || '-'}</td>
                    <td>${formatChange(token.change_5m)}</td>
                    <td>${formatChange(token.change_1h)}</td>
                    <td>${formatChange(token.change_6h)}</td>
                    <td>${formatChange(token.change_24h)}</td>
                    <td class="monospace">$${formatNumber(token.market_cap_usd)}</td>
                </tr>
            `;
        }

        function filterTokens() {
            let filtered = [...allTokens];
            
            switch(currentFilter) {
                case 'hot':
                    filtered = filtered.filter(t => t.progress >= 80);
                    break;
                case 'new':
                    filtered = filtered.filter(t => t.age < 3600); // Less than 1 hour
                    break;
                case 'large':
                    filtered = filtered.filter(t => t.market_cap_usd >= 100000);
                    break;
            }
            
            return filtered;
        }

        function updateStats() {
            const activeTokens = allTokens.length;
            const totalLiquidity = allTokens.reduce((sum, t) => sum + t.liquidity_sol, 0);
            const nearGrad = allTokens.filter(t => t.progress >= 80).length;
            const avgProgress = allTokens.length > 0 ?
                allTokens.reduce((sum, t) => sum + t.progress, 0) / allTokens.length : 0;

            document.getElementById('activeTokens').textContent = activeTokens;
            document.getElementById('totalLiquidity').textContent = `${totalLiquidity.toFixed(2)} SOL`;
            document.getElementById('nearGraduation').textContent = nearGrad;
            document.getElementById('avgProgress').textContent = `${avgProgress.toFixed(1)}%`;
        }

        function updateDisplay() {
            const filtered = filterTokens();
            const tbody = document.getElementById('token-list');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            No tokens found matching filter
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(renderToken).join('');
            }
        }

        async function fetchTokens() {
            document.getElementById('spinner').style.display = 'block';
            
            try {
                const response = await fetch('/api/bonding');
                const data = await response.json();
                
                if (data.success) {
                    allTokens = data.tokens;
                    updateStats();
                    updateDisplay();
                    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error fetching tokens:', error);
                document.getElementById('token-list').innerHTML = `
                    <tr>
                        <td colspan="11" class="error-state">
                            Error loading tokens. Please refresh the page.
                        </td>
                    </tr>
                `;
            } finally {
                document.getElementById('spinner').style.display = 'none';
            }
        }

        // Filter button handlers
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.getAttribute('data-filter');
                updateDisplay();
            });
        });

        // Load system status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    // Update SOL price
                    document.getElementById('sol-price').textContent = `$${data.sol_price.price.toFixed(2)}`;
                    document.getElementById('price-source').textContent = `(${data.sol_price.source})`;
                    
                    // Update connection status
                    const connectionDot = document.getElementById('connection-dot');
                    const connectionStatus = document.getElementById('connection-status');
                    if (data.connection.status === 'connected') {
                        connectionDot.classList.remove('disconnected');
                        connectionDot.classList.add('connected');
                        connectionStatus.textContent = 'Connected';
                    } else {
                        connectionDot.classList.remove('connected');
                        connectionDot.classList.add('disconnected');
                        connectionStatus.textContent = 'Disconnected';
                    }
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Initial load
        fetchTokens();
        loadStatus();
        
        // Refresh every 10 seconds
        setInterval(fetchTokens, 10000);
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graduated Tokens - Pump.fun Monitor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="status-bar">
        <div class="status-item">
            <span class="status-label">SOL Price:</span>
            <span class="status-value sol-price" id="sol-price">$---.--</span>
            <span class="price-source" id="price-source"></span>
        </div>
        <div class="status-item">
            <span class="status-label">System:</span>
            <div class="connection-indicator">
                <div class="connection-dot" id="connection-dot"></div>
                <span class="status-value" id="connection-status">Checking...</span>
            </div>
        </div>
        <div class="status-item">
            <span class="status-label">Total Graduated:</span>
            <span class="status-value" id="totalTokens">-</span>
        </div>
        <div class="status-item">
            <span class="status-label">Total Market Cap:</span>
            <span class="status-value" id="totalMarketCap">-</span>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ðŸ’Ž Graduated Tokens</h1>
            <div class="header-controls">
                <div class="nav-section">
                    <a href="/" class="nav-link">All Tokens</a>
                    <a href="/bonding.html" class="nav-link">Bonding Curve</a>
                    <a href="/graduated.html" class="nav-link active">Graduated</a>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="1h">1 Hour</button>
                    <button class="filter-btn" data-filter="24h">24 Hours</button>
                    <button class="filter-btn" data-filter="7d">7 Days</button>
                </div>
                <div class="refresh-indicator">
                    <div class="refresh-spinner"></div>
                    <span>Live</span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Graduated</div>
                <div class="stat-value" id="totalTokens">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Market Cap</div>
                <div class="stat-value" id="totalMarketCap">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Market Cap</div>
                <div class="stat-value" id="avgMarketCap">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Update</div>
                <div class="stat-value" id="lastUpdate">-</div>
            </div>
        </div>

        <div class="table-container">
            <table class="token-table">
                <thead>
                    <tr>
                        <th class="text-left">Token</th>
                        <th>Price</th>
                        <th>Market Cap</th>
                        <th>Change</th>
                        <th>Graduated</th>
                        <th>Age</th>
                        <th>Holders</th>
                        <th>Top Holder</th>
                    </tr>
                </thead>
                <tbody id="tokenList">
                    <tr>
                        <td colspan="8" class="loading">Loading graduated tokens...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="pagination"></div>

        <div class="footer">
            <p>Monitoring graduated Pump.fun tokens â€¢ Updates every 30 seconds</p>
        </div>
    </div>

    <script>
        const TOKENS_PER_PAGE = 100;
        let currentPage = 1;
        let allTokens = [];
        let filteredTokens = [];
        let currentFilter = 'all';

        // Format market cap
        function formatMarketCap(mcap) {
            if (mcap >= 1000000) {
                return '$' + (mcap / 1000000).toFixed(2) + 'M';
            } else if (mcap >= 1000) {
                return '$' + (mcap / 1000).toFixed(2) + 'K';
            }
            return '$' + mcap.toFixed(2);
        }

        // Format price
        function formatPrice(price) {
            if (price < 0.00001) {
                return '$' + price.toExponential(2);
            } else if (price < 0.01) {
                return '$' + price.toFixed(6);
            } else if (price < 1) {
                return '$' + price.toFixed(4);
            }
            return '$' + price.toFixed(2);
        }

        // Format percentage
        function formatPercentage(value) {
            const formatted = Math.abs(value).toFixed(2);
            const sign = value >= 0 ? '+' : '-';
            return sign + formatted + '%';
        }

        // Format time ago
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - new Date(timestamp).getTime();
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d`;
            if (hours > 0) return `${hours}h`;
            return `${minutes}m`;
        }

        // Filter tokens based on graduation time
        function filterTokens(filter) {
            const now = Date.now();
            const hour = 60 * 60 * 1000;
            const day = 24 * hour;
            const week = 7 * day;

            currentFilter = filter;

            switch (filter) {
                case '1h':
                    filteredTokens = allTokens.filter(t => {
                        const graduatedTime = new Date(t.graduated_at).getTime();
                        return now - graduatedTime <= hour;
                    });
                    break;
                case '24h':
                    filteredTokens = allTokens.filter(t => {
                        const graduatedTime = new Date(t.graduated_at).getTime();
                        return now - graduatedTime <= day;
                    });
                    break;
                case '7d':
                    filteredTokens = allTokens.filter(t => {
                        const graduatedTime = new Date(t.graduated_at).getTime();
                        return now - graduatedTime <= week;
                    });
                    break;
                default:
                    filteredTokens = [...allTokens];
            }

            currentPage = 1;
            displayTokens();
            updatePagination();
        }

        // Display tokens
        function displayTokens() {
            const tbody = document.getElementById('tokenList');
            const start = (currentPage - 1) * TOKENS_PER_PAGE;
            const end = start + TOKENS_PER_PAGE;
            const pageTokens = filteredTokens.slice(start, end);

            if (pageTokens.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No graduated tokens found</td></tr>';
                return;
            }

            tbody.innerHTML = pageTokens.map(token => {
                const priceChange = token.price_change_24h || 0;
                const changeClass = priceChange > 0 ? 'positive' : priceChange < 0 ? 'negative' : 'neutral';
                const holderClass = token.top_holder_percentage >= 20 ? 'high' : 
                                   token.top_holder_percentage >= 10 ? 'medium' : 'low';

                return `
                    <tr onclick="window.open('https://pump.fun/${token.mint}', '_blank')">
                        <td>
                            <div class="token-info">
                                <div class="token-icon">${token.symbol?.charAt(0).toUpperCase() || '?'}</div>
                                <div class="token-details">
                                    <div class="symbol">${token.symbol || 'Unknown'}</div>
                                    <div class="name">${token.name || 'Unknown Token'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="price">${formatPrice(token.current_price || 0)}</td>
                        <td>${formatMarketCap(token.market_cap || 0)}</td>
                        <td class="change ${changeClass}">${formatPercentage(priceChange)}</td>
                        <td class="age">${formatTimeAgo(token.graduated_at)}</td>
                        <td class="age">${formatTimeAgo(token.created_at)}</td>
                        <td class="holder-count">${token.holder_count || '-'}</td>
                        <td class="top-holder ${holderClass}">
                            ${token.top_holder_percentage ? token.top_holder_percentage.toFixed(1) + '%' : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update stats
        function updateStats() {
            const totalTokens = filteredTokens.length;
            const totalMarketCap = filteredTokens.reduce((sum, token) => sum + (token.market_cap || 0), 0);
            const avgMarketCap = totalTokens > 0 ? totalMarketCap / totalTokens : 0;

            document.getElementById('totalTokens').textContent = totalTokens.toLocaleString();
            document.getElementById('totalMarketCap').textContent = formatMarketCap(totalMarketCap);
            document.getElementById('avgMarketCap').textContent = formatMarketCap(avgMarketCap);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredTokens.length / TOKENS_PER_PAGE);
            const paginationDiv = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }

            let html = '<div class="pagination-controls">';
            
            // Previous button
            html += `<button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                     onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                     Previous</button>`;

            // Page numbers
            html += '<div class="page-numbers">';
            const maxVisible = 5;
            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);

            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            if (start > 1) {
                html += '<button class="page-btn" onclick="changePage(1)">1</button>';
                if (start > 2) html += '<span class="page-dots">...</span>';
            }

            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                         onclick="changePage(${i})">${i}</button>`;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) html += '<span class="page-dots">...</span>';
                html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            html += '</div>';

            // Next button
            html += `<button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                     onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                     Next</button>`;

            html += `<span class="page-info">Page ${currentPage} of ${totalPages}</span>`;
            html += '</div>';

            paginationDiv.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredTokens.length / TOKENS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayTokens();
            updatePagination();
            window.scrollTo(0, 0);
        }

        // Fetch tokens
        async function fetchTokens() {
            const spinner = document.querySelector('.refresh-spinner');
            spinner.classList.add('active');

            try {
                const response = await fetch('/api/tokens/graduated');
                const data = await response.json();

                if (data.success) {
                    allTokens = data.tokens.sort((a, b) => 
                        new Date(b.graduated_at).getTime() - new Date(a.graduated_at).getTime()
                    );
                    filterTokens(currentFilter);
                    updateStats();
                } else {
                    throw new Error(data.error || 'Failed to fetch tokens');
                }
            } catch (error) {
                console.error('Error fetching tokens:', error);
                document.getElementById('tokenList').innerHTML = 
                    '<tr><td colspan="8" class="error-state">Error loading tokens. Please try again.</td></tr>';
            } finally {
                setTimeout(() => spinner.classList.remove('active'), 500);
            }
        }

        // Setup filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterTokens(btn.dataset.filter);
            });
        });

        // Load system status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    // Update SOL price
                    document.getElementById('sol-price').textContent = `$${data.sol_price.price.toFixed(2)}`;
                    document.getElementById('price-source').textContent = `(${data.sol_price.source})`;
                    
                    // Update connection status
                    const connectionDot = document.getElementById('connection-dot');
                    const connectionStatus = document.getElementById('connection-status');
                    if (data.connection.status === 'connected') {
                        connectionDot.classList.remove('disconnected');
                        connectionDot.classList.add('connected');
                        connectionStatus.textContent = 'Connected';
                    } else {
                        connectionDot.classList.remove('connected');
                        connectionDot.classList.add('disconnected');
                        connectionStatus.textContent = 'Disconnected';
                    }
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Initial load and refresh
        fetchTokens();
        loadStatus();
        setInterval(fetchTokens, 30000);
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
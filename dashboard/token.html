<!DOCTYPE html>
<html>
<head>
    <title>Token Details - Pump Monitor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0d0d0d;
            color: #e4e4e7;
            line-height: 1.6;
        }

        /* Loading State */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0d0d0d;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .loading-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #262626;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: #1a1a1a;
            border-bottom: 1px solid #262626;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e4e4e7;
            text-decoration: none;
            padding: 8px 16px;
            background: #27272a;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #3b3b3b;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 24px;
        }

        /* Error State */
        .error-container {
            background: #1a1a1a;
            border: 1px solid #dc2626;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-top: 50px;
        }

        .error-title {
            font-size: 24px;
            color: #ef4444;
            margin-bottom: 8px;
        }

        .error-container code {
            background: #27272a;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #e4e4e7;
        }

        /* Token Header */
        .token-header {
            background: #1a1a1a;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .token-title {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .token-icon-large {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #27272a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 24px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .token-icon-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .token-names {
            flex: 1;
            min-width: 0;
        }

        .token-symbol-large {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .token-name-large {
            font-size: 16px;
            color: #71717a;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .token-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 12px;
            background: #27272a;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.graduated {
            background: #10b981;
            color: #fff;
        }

        .badge.new {
            background: #3b82f6;
            color: #fff;
        }

        .badge.bonding {
            background: #f59e0b;
            color: #fff;
        }

        /* Price Section */
        .price-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }

        .price-item {
            text-align: center;
        }

        .price-label {
            font-size: 12px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .price-value {
            font-size: 28px;
            font-weight: 600;
            color: #fff;
        }

        .price-change-large {
            font-size: 18px;
            margin-top: 4px;
        }

        .price-change-large.positive {
            color: #10b981;
        }

        .price-change-large.negative {
            color: #ef4444;
        }

        .price-change-large.neutral {
            color: #71717a;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        /* Chart Container */
        .chart-container {
            background: #1a1a1a;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 24px;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #71717a;
        }

        /* Info Cards */
        .info-card {
            background: #1a1a1a;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .info-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #262626;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #71717a;
            font-size: 14px;
        }

        .info-value {
            color: #e4e4e7;
            font-size: 14px;
            font-weight: 500;
            text-align: right;
        }

        /* Links Section */
        .links-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .external-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #27272a;
            border: 1px solid #3b3b3b;
            border-radius: 8px;
            color: #e4e4e7;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .external-link:hover {
            background: #3b3b3b;
            border-color: #3b82f6;
        }

        /* Copy Button */
        .copy-address {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #27272a;
            border: 1px solid #3b3b3b;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 200px;
        }

        .copy-address:hover {
            background: #3b3b3b;
        }

        .copy-address.copied {
            background: #10b981;
            color: #fff;
            border-color: #10b981;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #27272a;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #71717a;
        }

        /* Trading Stats */
        .trading-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .stat-item {
            background: #27272a;
            padding: 12px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: #71717a;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .price-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .token-symbol-large {
                font-size: 24px;
            }
            
            .price-value {
                font-size: 20px;
            }
            
            .links-section {
                flex-direction: column;
            }
            
            .external-link {
                width: 100%;
                justify-content: center;
            }
            
            .trading-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div class="loading-container" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="back-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
                Back to Explorer
            </a>
            
            <div class="connection-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container" id="main-container" style="display: none;">
        <!-- Token Header -->
        <div class="token-header">
            <div class="token-title">
                <div class="token-icon-large" id="token-icon">
                    <span>?</span>
                </div>
                <div class="token-names">
                    <div class="token-symbol-large">
                        <span id="token-symbol">...</span>
                        <div class="token-badges" id="token-badges"></div>
                    </div>
                    <div class="token-name-large" id="token-name">Loading...</div>
                </div>
            </div>
            
            <div class="price-section">
                <div class="price-item">
                    <div class="price-label">Price</div>
                    <div class="price-value" id="price-usd">-</div>
                    <div class="price-change-large neutral" id="price-change-24h">-</div>
                </div>
                <div class="price-item">
                    <div class="price-label">Market Cap</div>
                    <div class="price-value" id="market-cap">-</div>
                </div>
                <div class="price-item">
                    <div class="price-label">Liquidity</div>
                    <div class="price-value" id="liquidity">-</div>
                </div>
                <div class="price-item">
                    <div class="price-label">24h Volume</div>
                    <div class="price-value" id="volume-24h">-</div>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Chart Section -->
            <div>
                <div class="chart-container">
                    <p>Price chart coming soon...</p>
                </div>
            </div>

            <!-- Info Section -->
            <div>
                <!-- Token Info -->
                <div class="info-card">
                    <h3>Token Information</h3>
                    <div class="info-row">
                        <span class="info-label">Contract Address</span>
                        <div class="copy-address" id="copy-address" onclick="copyAddress()">
                            <span id="address-short">-</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Created</span>
                        <span class="info-value" id="created-at">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Creator</span>
                        <span class="info-value" id="creator">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Supply</span>
                        <span class="info-value">1,000,000,000</span>
                    </div>
                </div>

                <!-- Trading Stats -->
                <div class="info-card">
                    <h3>Trading Activity</h3>
                    <div class="trading-stats">
                        <div class="stat-item">
                            <div class="stat-label">1h Change</div>
                            <div class="stat-value" id="price-change-1h">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">24h Trades</div>
                            <div class="stat-value" id="trade-count">-</div>
                        </div>
                    </div>
                </div>

                <!-- Bonding Curve Progress (conditional) -->
                <div class="info-card" id="bonding-card" style="display: none;">
                    <h3>Bonding Curve Progress</h3>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-percent">0%</span>
                            <span id="progress-sol">0 / 85,000 SOL</span>
                        </div>
                    </div>
                </div>

                <!-- Links -->
                <div class="info-card">
                    <h3>Links & Resources</h3>
                    <div class="links-section">
                        <a href="#" id="pump-link" target="_blank" class="external-link" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            View on Pump.fun
                        </a>
                        <a href="#" id="solscan-link" target="_blank" class="external-link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Solscan
                        </a>
                        <a href="#" id="dexscreener-link" target="_blank" class="external-link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"></path>
                                <path d="m19 9-5 5-4-4-3 3"></path>
                            </svg>
                            DexScreener
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Container -->
    <div class="container" id="error-container" style="display: none;">
        <div class="error-container">
            <h2 class="error-title">Token Not Found</h2>
            <p>The token you're looking for doesn't exist or hasn't been indexed yet.</p>
            <p style="margin-top: 10px; font-size: 14px; color: #71717a;">
                Token Address: <code style="background: #27272a; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;" id="error-address"></code>
            </p>
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <a href="/" class="back-button">
                    Back to Explorer
                </a>
                <button onclick="retryConnection()" class="back-button" style="background: #3b82f6; border: none; cursor: pointer;">
                    Retry Connection
                </button>
            </div>
            <div id="debug-info" style="margin-top: 20px; padding: 16px; background: #1a1a1a; border-radius: 8px; text-align: left; font-size: 12px; color: #71717a; display: none;">
                <h4 style="color: #fff; margin-bottom: 8px;">Debug Information:</h4>
                <div id="debug-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Get token address from URL
        const tokenAddress = window.location.pathname.split('/').pop();
        let ws = null;
        let reconnectTimer = null;
        let tokenData = null;

        // DOM Elements
        const elements = {
            loading: document.getElementById('loading'),
            mainContainer: document.getElementById('main-container'),
            errorContainer: document.getElementById('error-container'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            tokenIcon: document.getElementById('token-icon'),
            tokenSymbol: document.getElementById('token-symbol'),
            tokenName: document.getElementById('token-name'),
            tokenBadges: document.getElementById('token-badges'),
            priceUsd: document.getElementById('price-usd'),
            priceChange24h: document.getElementById('price-change-24h'),
            priceChange1h: document.getElementById('price-change-1h'),
            marketCap: document.getElementById('market-cap'),
            liquidity: document.getElementById('liquidity'),
            volume24h: document.getElementById('volume-24h'),
            addressShort: document.getElementById('address-short'),
            createdAt: document.getElementById('created-at'),
            creator: document.getElementById('creator'),
            tradeCount: document.getElementById('trade-count'),
            bondingCard: document.getElementById('bonding-card'),
            progressFill: document.getElementById('progress-fill'),
            progressPercent: document.getElementById('progress-percent'),
            progressSol: document.getElementById('progress-sol'),
            pumpLink: document.getElementById('pump-link'),
            solscanLink: document.getElementById('solscan-link'),
            dexscreenerLink: document.getElementById('dexscreener-link')
        };

        // Initialize WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.hostname}:8080`;
            
            console.log('üîå Attempting WebSocket connection to:', wsUrl);
            console.log('üìç Token address:', tokenAddress);
            
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('‚úÖ Connected to WebSocket');
                    updateConnectionStatus(true);
                    
                    // Subscribe to this specific token
                    const subscribeMsg = { 
                        type: 'subscribe_token', 
                        address: tokenAddress 
                    };
                    console.log('üì§ Sending subscribe message:', subscribeMsg);
                    ws.send(JSON.stringify(subscribeMsg));
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        console.log('üì• Received message:', msg);
                        
                        // Handle different message types
                        if (msg.type === 'token_update') {
                            if (msg.data && msg.data.address === tokenAddress) {
                                console.log('‚úÖ Token data received:', msg.data);
                                updateTokenData(msg.data);
                                hideLoading();
                            } else if (msg.data === null) {
                                console.log('‚ùå Token not found in database');
                                showError();
                            }
                        } else if (msg.type === 'tokens') {
                            // Check if our token is in the active tokens list
                            const ourToken = msg.data.find(t => t.address === tokenAddress);
                            if (ourToken) {
                                console.log('‚úÖ Found token in active list:', ourToken);
                                updateTokenData(ourToken);
                                hideLoading();
                            }
                        }
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                    updateConnectionStatus(false);
                };

                ws.onclose = (event) => {
                    console.log('‚ùå WebSocket disconnected:', event.code, event.reason);
                    updateConnectionStatus(false);
                    scheduleReconnect();
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                updateConnectionStatus(false);
                scheduleReconnect();
            }
        }

        // Schedule reconnection
        function scheduleReconnect() {
            if (reconnectTimer) clearTimeout(reconnectTimer);
            reconnectTimer = setTimeout(() => {
                console.log('Attempting to reconnect...');
                initWebSocket();
            }, 5000);
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            elements.statusDot.classList.toggle('connected', connected);
            elements.statusText.textContent = connected ? 'Connected' : 'Disconnected';
        }

        // Hide loading screen
        function hideLoading() {
            elements.loading.classList.add('hidden');
            elements.mainContainer.style.display = 'block';
        }

        // Show error screen
        function showError() {
            elements.loading.classList.add('hidden');
            elements.errorContainer.style.display = 'block';
        }

        // Try to fetch token data via API as fallback
        async function fetchTokenViaAPI() {
            try {
                console.log('üîÑ Attempting API fallback...');
                const response = await fetch(`/api/token/${tokenAddress}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.address) {
                        console.log('‚úÖ Token data from API:', data);
                        updateTokenData(data);
                        hideLoading();
                        return true;
                    }
                }
            } catch (error) {
                console.error('API fallback failed:', error);
            }
            return false;
        }

        // Update token data
        function updateTokenData(data) {
            try {
                console.log('üìä Updating token data:', data);
                tokenData = data;
                
                // Update icon
                if (data.image_uri) {
                    elements.tokenIcon.innerHTML = `<img src="${data.image_uri}" alt="${data.symbol || 'Token'}" onerror="this.parentElement.innerHTML='<span>${(data.symbol || '?').charAt(0).toUpperCase()}</span>'">`;
                } else {
                    elements.tokenIcon.innerHTML = `<span>${(data.symbol || '?').charAt(0).toUpperCase()}</span>`;
                }
                
                // Update basic info
                elements.tokenSymbol.textContent = data.symbol || 'Unknown';
                elements.tokenName.textContent = data.name || tokenAddress.slice(0, 16) + '...';
                
                // Update badges
                elements.tokenBadges.innerHTML = '';
                if (data.graduated) {
                    elements.tokenBadges.innerHTML += '<span class="badge graduated">Graduated</span>';
                } else if (data.bonding_complete === false) {
                    elements.tokenBadges.innerHTML += '<span class="badge bonding">Bonding</span>';
                }
                
                const createdDate = new Date(data.created_at);
                const isNew = createdDate > new Date(Date.now() - 86400000); // 24 hours
                if (isNew) {
                    elements.tokenBadges.innerHTML += '<span class="badge new">New</span>';
                }
                
                // Update prices
                const priceValue = parseFloat(data.current_price) || 0;
                elements.priceUsd.textContent = '$' + formatPrice(priceValue);
                elements.marketCap.textContent = '$' + formatNumber(data.current_mcap || 0);
                elements.liquidity.textContent = '$' + formatNumber(data.current_liquidity || 0);
                
                // Volume might not be available in basic data
                if (data.volume_24h !== undefined) {
                    elements.volume24h.textContent = '$' + formatNumber(data.volume_24h);
                } else {
                    elements.volume24h.textContent = '-';
                }
                
                // Update price changes (might not be available)
                if (data.price_change_24h !== undefined) {
                    updatePriceChange(elements.priceChange24h, data.price_change_24h, '24h');
                } else {
                    elements.priceChange24h.textContent = '-';
                    elements.priceChange24h.className = 'price-change-large neutral';
                }
                
                if (data.price_change_1h !== undefined) {
                    updatePriceChange(elements.priceChange1h, data.price_change_1h, '1h');
                } else {
                    // Hide the 1h change stat if not available
                    const stat1h = elements.priceChange1h.closest('.stat-item');
                    if (stat1h) stat1h.style.display = 'none';
                }
                
                // Update info
                elements.addressShort.textContent = 
                    tokenAddress.slice(0, 6) + '...' + tokenAddress.slice(-4);
                elements.createdAt.textContent = formatDate(data.created_at);
                elements.creator.textContent = 
                    data.creator ? data.creator.slice(0, 6) + '...' + data.creator.slice(-4) : '-';
                
                // Update trading stats (might not be available)
                if (data.trade_count_24h !== undefined) {
                    elements.tradeCount.textContent = formatNumber(data.trade_count_24h, 0);
                } else {
                    // Hide the trade count stat if not available
                    const tradeStat = elements.tradeCount.closest('.stat-item');
                    if (tradeStat) tradeStat.style.display = 'none';
                }
                
                // Update bonding curve progress
                if (!data.graduated) {
                    // Try to calculate bonding progress
                    let progress = 0;
                    let currentSol = 0;
                    
                    if (data.bonding_progress !== undefined) {
                        progress = parseFloat(data.bonding_progress);
                    } else if (data.current_liquidity_sol !== undefined) {
                        currentSol = parseFloat(data.current_liquidity_sol);
                        progress = (currentSol / 85000) * 100;
                    } else if (data.current_liquidity && data.sol_price) {
                        // Calculate SOL amount from USD liquidity
                        currentSol = parseFloat(data.current_liquidity) / parseFloat(data.sol_price);
                        progress = (currentSol / 85000) * 100;
                    }
                    
                    // Only show bonding card if we have meaningful progress data
                    if (progress > 0 || currentSol > 0) {
                        elements.bondingCard.style.display = 'block';
                        progress = Math.min(progress, 100);
                        elements.progressFill.style.width = progress + '%';
                        elements.progressPercent.textContent = progress.toFixed(2) + '%';
                        elements.progressSol.textContent = 
                            `${formatNumber(currentSol)} / 85,000 SOL`;
                    } else {
                        elements.bondingCard.style.display = 'none';
                    }
                } else {
                    elements.bondingCard.style.display = 'none';
                }
                
                // Update links
                if (data.vanity_id) {
                    elements.pumpLink.href = `https://pump.fun/${data.vanity_id}`;
                    elements.pumpLink.style.display = 'flex';
                } else {
                    elements.pumpLink.style.display = 'none';
                }
                elements.solscanLink.href = `https://solscan.io/token/${tokenAddress}`;
                elements.dexscreenerLink.href = `https://dexscreener.com/solana/${tokenAddress}`;
                
                console.log('‚úÖ Token data updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating token data:', error);
                console.error('Data that caused error:', data);
            }
        }

        // Update price change element
        function updatePriceChange(element, change, period) {
            if (change !== undefined && change !== null) {
                const changeNum = parseFloat(change);
                const sign = changeNum >= 0 ? '+' : '';
                element.textContent = sign + changeNum.toFixed(2) + '%';
                element.className = 'price-change-large ' + 
                    (changeNum > 0 ? 'positive' : changeNum < 0 ? 'negative' : 'neutral');
                
                if (period === '1h') {
                    element.parentElement.querySelector('.stat-value').textContent = 
                        sign + changeNum.toFixed(2) + '%';
                    element.parentElement.querySelector('.stat-value').style.color = 
                        changeNum > 0 ? '#10b981' : changeNum < 0 ? '#ef4444' : '#71717a';
                }
            } else {
                element.textContent = '-';
                element.className = 'price-change-large neutral';
            }
        }

        // Copy address function
        function copyAddress() {
            navigator.clipboard.writeText(tokenAddress).then(() => {
                const copyBtn = document.getElementById('copy-address');
                copyBtn.classList.add('copied');
                const originalText = elements.addressShort.textContent;
                elements.addressShort.textContent = 'Copied!';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    elements.addressShort.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Format helpers
        function formatPrice(price) {
            // Convert to number if it's a string
            const p = parseFloat(price) || 0;
            if (p === 0) return '0.00';
            if (p < 0.000001) return p.toExponential(2);
            if (p < 0.01) return p.toFixed(6);
            if (p < 1) return p.toFixed(4);
            return p.toFixed(2);
        }

        function formatNumber(num, decimals = 2) {
            const n = parseFloat(num) || 0;
            if (n === 0) return '0';
            if (n >= 1e9) return (n / 1e9).toFixed(decimals) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(decimals) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(decimals) + 'K';
            return n.toFixed(decimals);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Initialize
        function init() {
            // Validate token address
            if (!tokenAddress || tokenAddress.length < 32) {
                console.error('‚ùå Invalid token address:', tokenAddress);
                showError();
                document.getElementById('error-address').textContent = tokenAddress || 'Invalid';
                return;
            }

            document.getElementById('error-address').textContent = tokenAddress;

            // Set a timeout for initial load
            const loadTimeout = setTimeout(() => {
                if (!tokenData) {
                    console.log('‚è±Ô∏è Load timeout - token not received within 10 seconds');
                    showError();
                    showDebugInfo();
                }
            }, 10000);

            // Store timeout reference for cleanup
            window.loadTimeout = loadTimeout;

            // Initialize WebSocket
            initWebSocket();
        }

        // Retry connection
        function retryConnection() {
            console.log('üîÑ Retrying connection...');
            
            // Clear any existing timeout
            if (window.loadTimeout) {
                clearTimeout(window.loadTimeout);
            }
            
            // Hide error, show loading
            elements.errorContainer.style.display = 'none';
            elements.loading.classList.remove('hidden');
            
            // Close existing connection if any
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            // Reinitialize
            tokenData = null;
            init();
        }

        // Show debug information
        function showDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            debugInfo.style.display = 'block';
            debugContent.innerHTML = `
                <p>WebSocket URL: ${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.hostname}:8080</p>
                <p>Connection Status: ${ws ? `${ws.readyState} (0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED)` : 'Not initialized'}</p>
                <p>Token Address: ${tokenAddress}</p>
                <p>Token Data Received: ${tokenData ? 'Yes' : 'No'}</p>
                <p style="margin-top: 8px;">Possible issues:</p>
                <ul style="margin-left: 20px; margin-top: 4px;">
                    <li>WebSocket server might not be running on port 8080</li>
                    <li>Token hasn't been indexed by the monitoring system yet</li>
                    <li>Token might be archived (market cap < $15k)</li>
                    <li>Database connection issue</li>
                </ul>
                <p style="margin-top: 8px;">Check console for detailed logs (F12 ‚Üí Console)</p>
            `;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.loadTimeout) clearTimeout(window.loadTimeout);
            if (reconnectTimer) clearTimeout(reconnectTimer);
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ 
                    type: 'unsubscribe_token', 
                    address: tokenAddress 
                }));
                ws.close();
            }
        });

        // Start the application
        init();
    </script>
</body>
</html>
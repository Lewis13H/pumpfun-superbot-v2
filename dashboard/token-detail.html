<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Detail - Loading...</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Token Header */
        .token-header {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid #2a2a2a;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .token-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .token-icon {
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .token-name {
            font-size: 20px;
            font-weight: 600;
        }
        
        .token-symbol {
            color: #888;
            font-size: 14px;
        }
        
        .price-display {
            text-align: right;
        }
        
        .price {
            font-size: 24px;
            font-weight: 600;
        }
        
        .price-change {
            font-size: 13px;
            margin-top: 2px;
        }
        
        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #aaa;
        }
        
        .header-stats span {
            color: #fff;
            font-weight: 600;
        }
        
        /* Score Cards Container */
        .score-cards-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* Score Badge */
        .score-badge {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #2a2a2a;
        }
        
        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .score-title {
            font-size: 12px;
            font-weight: 600;
            color: #aaa;
        }
        
        .score-value {
            font-size: 16px;
            font-weight: 700;
            display: block;
            margin-top: 4px;
        }
        
        .score-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #4CAF50;
            color: white;
        }
        
        .score-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        /* Different score colors */
        .score-total .score-fill {
            background: linear-gradient(90deg, #2196F3, #03A9F4);
        }
        
        .score-bc .score-fill {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }
        
        .score-social .score-fill {
            background: linear-gradient(90deg, #9C27B0, #E91E63);
        }
        
        .score-technical .score-fill {
            background: linear-gradient(90deg, #607D8B, #78909C);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 4px;
            border: 1px solid #2a2a2a;
        }
        
        .tab {
            flex: 1;
            padding: 8px 16px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: #222;
        }
        
        .tab.active {
            background: #2a2a2a;
            color: #4CAF50;
        }
        
        /* Content Area */
        .content-area {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2a2a2a;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }
        
        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        /* Score Breakdown */
        .score-breakdown {
            background: #222;
            border-radius: 6px;
            padding: 15px;
            font-size: 12px;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .score-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .score-label {
            color: #aaa;
        }
        
        .score-points {
            font-weight: 600;
        }
        
        .negative {
            color: #f44336;
        }
        
        .positive {
            color: #4CAF50;
        }
        
        /* Distribution Chart */
        .distribution-chart {
            background: #222;
            border-radius: 6px;
            padding: 15px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .chart-placeholder {
            width: 150px;
            height: 150px;
            background: #333;
            border-radius: 50%;
            margin-bottom: 15px;
        }
        
        .chart-legend {
            font-size: 11px;
            width: 100%;
        }
        
        .legend-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        /* Metric Box */
        .metric-box {
            background: #222;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th {
            background: #222;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            color: #aaa;
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
        }
        
        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .data-table tr:hover {
            background: #222;
        }
        
        /* Risk Badges */
        .risk-low {
            color: #4CAF50;
        }
        
        .risk-medium {
            color: #ff9800;
        }
        
        .risk-high {
            color: #f44336;
        }
        
        /* Address */
        .address {
            font-family: monospace;
            color: #66b3ff;
            cursor: pointer;
        }
        
        .address:hover {
            text-decoration: underline;
        }
        
        /* External Links */
        .external-links {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            font-size: 11px;
        }
        
        .external-link {
            color: #66b3ff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .external-link:hover {
            color: #4CAF50;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 100px 20px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 100px 20px;
            color: #f44336;
            font-size: 18px;
        }
        
        /* Status dot animation */
        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            margin-right: 6px;
            transition: background-color 0.3s ease;
        }
        
        .status-dot.connected {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .score-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header - Exact copy from index.html -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                🚀 PumpMonitor
            </a>
            <nav class="nav-links">
                <a href="/" class="nav-link">Tokens</a>
                <a href="/streaming-metrics.html" class="nav-link">Stream</a>
            </nav>
            <div class="header-right">
                <div class="sol-price-display">
                    <span class="sol-price-label">SOL</span>
                    <span class="sol-price-value" id="header-sol-price">$0.00</span>
                    <span class="sol-price-timestamp" id="header-sol-timestamp" title="Last updated"></span>
                </div>
                <div class="connection-status" id="connection-status">
                    <div class="status-dot" id="status-dot"></div>
                    <span class="stream-icon" id="stream-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <span class="status-text" id="status-text">Disconnected</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Loading/Error States -->
        <div id="loading" class="loading">Loading token details...</div>
        <div id="error" class="error" style="display: none;">Failed to load token details</div>
        
        <!-- Main Content (hidden while loading) -->
        <div id="content" style="display: none;">
            <!-- Token Header -->
            <div class="token-header">
                <div class="header-top">
                    <div class="token-title">
                        <div class="token-icon" id="token-icon">🪙</div>
                        <div>
                            <div class="token-name">
                                <span id="token-name">Loading...</span> <span class="token-symbol">(<span id="token-symbol">...</span>)</span>
                            </div>
                            <div class="external-links">
                                <a href="#" id="pump-link" class="external-link" target="_blank">🟢 Pump.fun ↗</a>
                                <a href="#" id="dexscreener-link" class="external-link" target="_blank">📊 DexScreener ↗</a>
                                <a href="#" id="birdeye-link" class="external-link" target="_blank">🦅 Birdeye ↗</a>
                                <a href="#" id="solscan-link" class="external-link" target="_blank">🔍 Solscan ↗</a>
                            </div>
                        </div>
                    </div>
                    <div class="price-display">
                        <div class="price" id="token-price">$0.00</div>
                        <div class="price-change" id="price-change">+0.0% (24h)</div>
                    </div>
                </div>
                <div class="header-stats">
                    <div>Market Cap: <span id="market-cap">$0</span></div>
                    <div>24h Volume: <span id="volume-24h">$0</span></div>
                    <div>Holders: <span id="holder-count">0</span></div>
                    <div>Liquidity: <span id="liquidity">0 SOL</span></div>
                    <div>Progress: <span id="progress">0%</span></div>
                </div>
            </div>

            <!-- Score Cards - 5 columns -->
            <div class="score-cards-container">
                <!-- Total Score -->
                <div class="score-badge score-total">
                    <div class="score-header">
                        <div>
                            <div class="score-title">Total Score</div>
                            <div class="score-value"><span id="total-score">0</span>/1000</div>
                        </div>
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" id="total-score-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Holder Score -->
                <div class="score-badge">
                    <div class="score-header">
                        <div>
                            <div class="score-title">Holder Score</div>
                            <div class="score-value"><span id="holder-score">0</span>/300</div>
                        </div>
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" id="holder-score-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- BC Curve Score -->
                <div class="score-badge score-bc">
                    <div class="score-header">
                        <div>
                            <div class="score-title">BC Curve Score</div>
                            <div class="score-value"><span id="bc-score">0</span>/300</div>
                        </div>
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" id="bc-score-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Social Score -->
                <div class="score-badge score-social">
                    <div class="score-header">
                        <div>
                            <div class="score-title">Social Score</div>
                            <div class="score-value"><span id="social-score">0</span>/200</div>
                        </div>
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" id="social-score-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Technical Score -->
                <div class="score-badge score-technical">
                    <div class="score-header">
                        <div>
                            <div class="score-title">Technical Score</div>
                            <div class="score-value"><span id="technical-score">0</span>/200</div>
                        </div>
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" id="technical-score-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab" onclick="switchTab('overview')">Overview</button>
                <button class="tab" onclick="switchTab('chart')">Price Chart</button>
                <button class="tab active" onclick="switchTab('holders')">Holders</button>
                <button class="tab" onclick="switchTab('transactions')">Transactions</button>
                <button class="tab" onclick="switchTab('pool')">Pool</button>
            </div>

            <!-- Content Area - Dynamic based on tab -->
            <div class="content-area" id="tab-content">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Get token address from URL (supports both 'address' and 'mint' parameters)
        const urlParams = new URLSearchParams(window.location.search);
        const tokenAddress = urlParams.get('address') || urlParams.get('mint');
        let currentTab = 'holders';
        let tokenData = null;

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderTabContent();
        }

        // Render tab content
        function renderTabContent() {
            const content = document.getElementById('tab-content');
            
            switch(currentTab) {
                case 'overview':
                    content.innerHTML = '<h2 class="section-title">Token Overview</h2><p>Overview content coming soon...</p>';
                    break;
                case 'chart':
                    content.innerHTML = '<h2 class="section-title">Price Chart</h2><p>Chart integration coming soon...</p>';
                    break;
                case 'holders':
                    renderHoldersTab();
                    break;
                case 'transactions':
                    content.innerHTML = '<h2 class="section-title">Recent Transactions</h2><p>Transactions coming soon...</p>';
                    break;
                case 'pool':
                    content.innerHTML = '<h2 class="section-title">Pool Information</h2><p>Pool info coming soon...</p>';
                    break;
            }
        }

        // Render holders tab
        function renderHoldersTab() {
            const content = document.getElementById('tab-content');
            
            // Check if we have holder analysis data
            const hasHolderData = false; // API doesn't return detailed holder analysis yet
            
            content.innerHTML = `
                <h2 class="section-title">Holder Analytics</h2>
                
                <!-- Score Breakdown and Distribution -->
                <div class="grid-2" style="margin-bottom: 20px;">
                    <div class="score-breakdown">
                        <h3 style="font-size: 14px; margin-bottom: 12px;">Score Breakdown</h3>
                        <div class="score-item">
                            <span class="score-label">Distribution</span>
                            <span class="score-points">88/100</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Decentralized</span>
                            <span class="score-points">88/100</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Organic</span>
                            <span class="score-points">88/100</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Dev Ethics</span>
                            <span class="score-points">8/50</span>
                        </div>
                        <div class="score-item" style="border-top: 1px solid #333; padding-top: 8px; margin-top: 8px;">
                            <span class="score-label">Sniper Risk</span>
                            <span class="score-points negative">-8</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Bot Activity</span>
                            <span class="score-points negative">-8</span>
                        </div>
                        <div class="score-item" style="border-top: 2px solid #333; padding-top: 8px; margin-top: 8px;">
                            <span class="score-label" style="font-weight: 600;">Total</span>
                            <span class="score-points" style="font-size: 14px;">${tokenData.holder_score || 88}/300</span>
                        </div>
                    </div>
                    
                    <div class="distribution-chart">
                        <div class="chart-placeholder"></div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <span>🟢 Organic</span>
                                <span>88.8%</span>
                            </div>
                            <div class="legend-item">
                                <span>🔴 Snipers</span>
                                <span>8.8%</span>
                            </div>
                            <div class="legend-item">
                                <span>🤖 Bots</span>
                                <span>8.8%</span>
                            </div>
                            <div class="legend-item">
                                <span>🐋 Whales</span>
                                <span>8.8%</span>
                            </div>
                            <div class="legend-item">
                                <span>👨‍💻 Dev</span>
                                <span>8%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics Grid -->
                <div class="grid-4" style="margin-bottom: 20px;">
                    <div class="metric-box">
                        <div class="metric-label">Total Holders</div>
                        <div class="metric-value" id="metric-holders">${tokenData.holder_count || 888}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Top 10 Hold</div>
                        <div class="metric-value" id="metric-top10">0.0%</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Top 25 Hold</div>
                        <div class="metric-value" id="metric-top25">0.0%</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Gini Coef</div>
                        <div class="metric-value" id="metric-gini">0.888</div>
                    </div>
                </div>

                <!-- Holder Classifications Table -->
                <h3 style="font-size: 14px; margin-bottom: 10px;">Holder Classifications</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Count</th>
                            <th>% Holders</th>
                            <th>% Supply</th>
                            <th>Risk</th>
                        </tr>
                    </thead>
                    <tbody id="holder-classifications-tbody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>

                <!-- Holder Growth Chart -->
                <div style="background: #222; border-radius: 6px; padding: 15px; margin: 20px 0;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">Holder Growth Chart</h3>
                    <div style="height: 150px; background: #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #666;">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit
                    </div>
                </div>

                <!-- Top Holders Table -->
                <h3 style="font-size: 14px; margin-bottom: 10px;">Top Holders</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Address</th>
                            <th>Balance</th>
                            <th>%</th>
                            <th>Type</th>
                            <th>First Buy</th>
                        </tr>
                    </thead>
                    <tbody id="top-holders-tbody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            `;
            
            // Update with live holder data if available
            if (tokenData.holder_count) {
                document.getElementById('metric-holders').textContent = formatNumber(tokenData.holder_count, 0);
            }
            
            // Update percentage metrics if holder analysis data is available
            if (tokenData.holder_analysis) {
                const top10 = parseFloat(tokenData.holder_analysis.top_10_percentage) || 0;
                const top25 = parseFloat(tokenData.holder_analysis.top_25_percentage) || 0;
                const gini = parseFloat(tokenData.holder_analysis.gini_coefficient) || 0;
                
                document.getElementById('metric-top10').textContent = `${top10.toFixed(1)}%`;
                document.getElementById('metric-top25').textContent = `${top25.toFixed(1)}%`;
                document.getElementById('metric-gini').textContent = gini.toFixed(3);
            }
            
            // Populate top holders table if data available
            if (tokenData.top_holders && tokenData.top_holders.length > 0) {
                const tbody = document.getElementById('top-holders-tbody');
                tbody.innerHTML = tokenData.top_holders.slice(0, 5).map(holder => {
                    // Format address
                    const addr = holder.wallet_address;
                    const shortAddr = addr.substring(0, 4) + '...' + addr.substring(addr.length - 4);
                    
                    // Format balance
                    const balance = parseFloat(holder.balance) / Math.pow(10, 6); // Assuming 6 decimals
                    let balanceText;
                    if (balance >= 1e6) {
                        balanceText = (balance / 1e6).toFixed(2) + 'M';
                    } else if (balance >= 1e3) {
                        balanceText = (balance / 1e3).toFixed(2) + 'K';
                    } else {
                        balanceText = balance.toFixed(2);
                    }
                    
                    // Format percentage
                    const percentage = parseFloat(holder.percentage_held) || 0;
                    
                    // Format type
                    const typeMap = {
                        'sniper': 'Sniper',
                        'bot': 'Bot',
                        'whale': 'Whale',
                        'developer': 'Dev',
                        'normal': 'Organic',
                        'bundler': 'Bundler'
                    };
                    const type = typeMap[holder.classification] || 'Unknown';
                    
                    // Format time
                    let timeText = 'Unknown';
                    if (holder.first_acquired) {
                        const time = new Date(holder.first_acquired);
                        const now = new Date();
                        const diffMs = now - time;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);
                        
                        if (diffDays > 0) {
                            timeText = diffDays + ' days ago';
                        } else if (diffHours > 0) {
                            timeText = diffHours + ' hours ago';
                        } else if (diffMins > 0) {
                            timeText = diffMins + ' mins ago';
                        } else {
                            timeText = 'Just now';
                        }
                    }
                    
                    return `
                        <tr>
                            <td>${holder.rank}</td>
                            <td class="address" title="${addr}">${shortAddr}</td>
                            <td>${balanceText}</td>
                            <td>${percentage.toFixed(2)}%</td>
                            <td>${type}</td>
                            <td>${timeText}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                // Show placeholder data
                const tbody = document.getElementById('top-holders-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">
                            No holder data available
                        </td>
                    </tr>
                `;
            }
            
            // Populate holder classifications table if data available
            if (tokenData.holder_analysis && tokenData.holder_analysis.wallet_type_distribution && tokenData.holder_analysis.supply_distribution) {
                const tbody = document.getElementById('holder-classifications-tbody');
                const distribution = tokenData.holder_analysis.wallet_type_distribution;
                const supplyDist = tokenData.holder_analysis.supply_distribution;
                const totalHolders = tokenData.holder_count || Object.values(distribution).reduce((a, b) => a + b, 0);
                
                const classifications = [
                    {
                        name: 'Organic',
                        count: distribution.organic || 0,
                        supplyPct: supplyDist.organic_pct || 0,
                        risk: 'low',
                        riskIcon: '✅ Low'
                    },
                    {
                        name: 'Snipers',
                        count: distribution.snipers || 0,
                        supplyPct: supplyDist.snipers_pct || 0,
                        risk: 'high',
                        riskIcon: '⚠️ High'
                    },
                    {
                        name: 'Bots',
                        count: distribution.bots || 0,
                        supplyPct: supplyDist.bots_pct || 0,
                        risk: 'medium',
                        riskIcon: '⚠️ Med'
                    },
                    {
                        name: 'Whales',
                        count: distribution.whales || 0,
                        supplyPct: supplyDist.whales_pct || 0,
                        risk: 'medium',
                        riskIcon: '⚠️ Med'
                    },
                    {
                        name: 'Developer',
                        count: distribution.developers || 0,
                        supplyPct: supplyDist.developers_pct || 0,
                        risk: 'low',
                        riskIcon: '✅ Low'
                    }
                ];
                
                tbody.innerHTML = classifications.map(cls => {
                    const holdersPct = totalHolders > 0 ? (cls.count / totalHolders * 100).toFixed(1) : '0.0';
                    return `
                        <tr>
                            <td>${cls.name}</td>
                            <td>${cls.count}</td>
                            <td>${holdersPct}%</td>
                            <td>${cls.supplyPct.toFixed(1)}%</td>
                            <td class="risk-${cls.risk}">${cls.riskIcon}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                // Show placeholder message
                const tbody = document.getElementById('holder-classifications-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #666;">
                            No classification data available
                        </td>
                    </tr>
                `;
            }
        }

        // Load token data
        async function loadTokenData() {
            if (!tokenAddress) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'No token address provided';
                return;
            }

            try {
                const response = await fetch(`/api/tokens/${tokenAddress}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                tokenData = await response.json();
                
                if (!tokenData) {
                    throw new Error('No data returned from API');
                }
                
                // Update UI with token data
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                updateTokenDisplay();
                renderTabContent();
                
                // Set page title
                document.title = `${tokenData.symbol || 'Token'} - Token Detail`;
                
            } catch (error) {
                console.error('Error loading token:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <div>Failed to load token details</div>
                    <div style="font-size: 14px; margin-top: 10px; color: #888;">${error.message}</div>
                    <div style="font-size: 12px; margin-top: 20px;">
                        <a href="/" style="color: #4CAF50;">← Back to Dashboard</a>
                    </div>
                `;
            }
        }

        // Update token display
        function updateTokenDisplay() {
            // Basic info - LIVE DATA
            document.getElementById('token-name').textContent = tokenData.name || 'Lorem Ipsum';
            document.getElementById('token-symbol').textContent = tokenData.symbol || 'LOREM';
            
            // Get the best available price - calculate from SOL price for accuracy
            const priceSol = parseFloat(tokenData.latest_price_sol) || parseFloat(tokenData.current_price_sol) || 0;
            const solPrice = parseFloat(tokenData.sol_price) || 0;
            
            // Calculate USD price from SOL price for better precision
            let currentPrice = 0;
            if (priceSol > 0 && solPrice > 0) {
                currentPrice = priceSol * solPrice;
            } else {
                // Fallback to stored USD prices
                currentPrice = parseFloat(tokenData.calculated_price_usd) || 
                              parseFloat(tokenData.current_price_usd) || 
                              parseFloat(tokenData.latest_price_usd) || 0;
            }
            
            // Format price with appropriate decimals based on value (added 2 more decimals)
            let priceText;
            if (currentPrice < 0.00001) {
                priceText = `$${currentPrice.toFixed(10)}`;
            } else if (currentPrice < 0.001) {
                priceText = `$${currentPrice.toFixed(8)}`;
            } else if (currentPrice < 1) {
                priceText = `$${currentPrice.toFixed(6)}`;
            } else {
                priceText = `$${formatNumber(currentPrice, 4)}`;
            }
            document.getElementById('token-price').textContent = priceText;
            
            // Add SOL price below USD price
            const priceDiv = document.getElementById('token-price').parentElement;
            let solPriceElement = document.getElementById('token-price-sol');
            if (!solPriceElement) {
                solPriceElement = document.createElement('div');
                solPriceElement.id = 'token-price-sol';
                solPriceElement.style.fontSize = '14px';
                solPriceElement.style.color = '#9C27B0';
                solPriceElement.style.marginTop = '2px';
                priceDiv.appendChild(solPriceElement);
            }
            
            // Format SOL price
            let solPriceText = '';
            if (priceSol < 0.000001) {
                solPriceText = `${priceSol.toFixed(12)} SOL`;
            } else if (priceSol < 0.001) {
                solPriceText = `${priceSol.toFixed(9)} SOL`;
            } else if (priceSol < 1) {
                solPriceText = `${priceSol.toFixed(6)} SOL`;
            } else {
                solPriceText = `${priceSol.toFixed(4)} SOL`;
            }
            solPriceElement.textContent = solPriceText;
            
            // Price change - Calculate from 24h history if available
            let priceChange = 0;
            let priceChangeText = '+0.0% (24h)';
            if (tokenData.price_history_24h && tokenData.price_history_24h.length > 0) {
                const oldPrice = parseFloat(tokenData.price_history_24h[tokenData.price_history_24h.length - 1].price_usd);
                if (oldPrice > 0) {
                    priceChange = ((currentPrice - oldPrice) / oldPrice) * 100;
                    priceChangeText = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(1)}% (24h)`;
                }
            }
            const priceChangeEl = document.getElementById('price-change');
            priceChangeEl.textContent = priceChangeText;
            priceChangeEl.className = priceChange >= 0 ? 'price-change positive' : 'price-change negative';
            
            // Stats - LIVE DATA
            document.getElementById('market-cap').textContent = `$${formatNumber(tokenData.current_market_cap_usd || tokenData.latest_market_cap_usd || 0)}`;
            document.getElementById('volume-24h').textContent = `$${formatNumber(tokenData.volume_24h_usd || 0)}`;
            // Holder count - use placeholder if no data
            const holderCount = tokenData.holder_count || 888;
            document.getElementById('holder-count').textContent = formatNumber(holderCount, 0);
            
            // Liquidity - Calculate from virtual reserves if available
            let liquiditySol = 0;
            if (tokenData.latest_virtual_sol_reserves) {
                liquiditySol = tokenData.latest_virtual_sol_reserves;
            } else if (tokenData.pool_info && tokenData.pool_info.virtual_sol_reserves) {
                liquiditySol = tokenData.pool_info.virtual_sol_reserves;
            }
            document.getElementById('liquidity').textContent = `${formatNumber(liquiditySol)} SOL`;
            
            // Progress - LIVE DATA
            const progress = parseFloat(tokenData.latest_bonding_curve_progress) || 0;
            document.getElementById('progress').textContent = `${progress.toFixed(1)}%`;
            
            // External links
            document.getElementById('pump-link').href = `https://pump.fun/${tokenAddress}`;
            document.getElementById('dexscreener-link').href = `https://dexscreener.com/solana/${tokenAddress}`;
            document.getElementById('birdeye-link').href = `https://birdeye.so/token/${tokenAddress}`;
            document.getElementById('solscan-link').href = `https://solscan.io/token/${tokenAddress}`;
            
            // Scores - LIVE holder score, others set to 0
            const holderScore = parseFloat(tokenData.holder_score) || 0;
            document.getElementById('holder-score').textContent = Math.round(holderScore);
            document.getElementById('holder-score-fill').style.width = `${(holderScore / 300) * 100}%`;
            
            // Other scores set to 0 for now
            const bcScore = 0;
            const socialScore = 0;
            const technicalScore = 0;
            
            document.getElementById('bc-score').textContent = bcScore;
            document.getElementById('bc-score-fill').style.width = `${(bcScore / 300) * 100}%`;
            
            document.getElementById('social-score').textContent = socialScore;
            document.getElementById('social-score-fill').style.width = `${(socialScore / 200) * 100}%`;
            
            document.getElementById('technical-score').textContent = technicalScore;
            document.getElementById('technical-score-fill').style.width = `${(technicalScore / 200) * 100}%`;
            
            // Total score is sum of all scores
            const totalScore = Math.round(holderScore) + bcScore + socialScore + technicalScore;
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('total-score-fill').style.width = `${(totalScore / 1000) * 100}%`;
            
            // Update token icon if image available
            if (tokenData.image_uri) {
                document.getElementById('token-icon').innerHTML = `<img src="${tokenData.image_uri}" alt="${tokenData.symbol}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
            }
            
            // Update holder metrics in renderHoldersTab if available
            if (tokenData.holder_analysis) {
                // Update metrics in the holders tab if it's active
                const top10El = document.getElementById('metric-top10');
                const top25El = document.getElementById('metric-top25');
                const giniEl = document.getElementById('metric-gini');
                
                if (top10El) {
                    const top10 = parseFloat(tokenData.holder_analysis.top_10_percentage) || 0;
                    top10El.textContent = `${top10.toFixed(1)}%`;
                }
                if (top25El) {
                    const top25 = parseFloat(tokenData.holder_analysis.top_25_percentage) || 0;
                    top25El.textContent = `${top25.toFixed(1)}%`;
                }
                if (giniEl) {
                    const gini = parseFloat(tokenData.holder_analysis.gini_coefficient) || 0;
                    giniEl.textContent = gini.toFixed(3);
                }
            }
        }

        // Format number helper
        function formatNumber(num, decimals = 2) {
            // Ensure num is a valid number
            const value = parseFloat(num) || 0;
            
            if (value >= 1e9) return (value / 1e9).toFixed(decimals) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(decimals) + 'M';
            if (value >= 1e3) return (value / 1e3).toFixed(decimals) + 'K';
            return value.toFixed(decimals);
        }

        // Initialize SOL price and connection status
        async function updateSystemStatus() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update SOL price
                    if (data.sol_price) {
                        document.getElementById('header-sol-price').textContent = `$${data.sol_price.price.toFixed(2)}`;
                        const timestamp = new Date(data.sol_price.timestamp);
                        const timeAgo = Math.floor((Date.now() - timestamp) / 1000);
                        let timeText = '';
                        if (timeAgo < 60) {
                            timeText = `${timeAgo}s`;
                        } else if (timeAgo < 3600) {
                            timeText = `${Math.floor(timeAgo / 60)}m`;
                        } else {
                            timeText = `${Math.floor(timeAgo / 3600)}h`;
                        }
                        document.getElementById('header-sol-timestamp').textContent = timeText;
                    }
                    
                    // Update connection status - consider it connected if we got a successful response
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Error updating system status:', error);
                updateConnectionStatus(false);
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(isConnected) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const streamIcon = document.getElementById('stream-icon');
            
            if (isConnected) {
                statusDot.classList.add('connected');
                statusDot.style.backgroundColor = '#4CAF50';
                statusText.textContent = 'Connected';
                statusText.style.color = '#4CAF50';
                streamIcon.style.color = '#4CAF50';
            } else {
                statusDot.classList.remove('connected');
                statusDot.style.backgroundColor = '#666';
                statusText.textContent = 'Disconnected';
                statusText.style.color = '#666';
                streamIcon.style.color = '#666';
            }
        }
        
        // Initialize
        loadTokenData();
        updateSystemStatus();
        
        // Auto refresh
        setInterval(loadTokenData, 30000);
        setInterval(updateSystemStatus, 10000);
    </script>
</body>
</html>